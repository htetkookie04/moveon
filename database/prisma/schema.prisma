// Prisma schema for Move on Calendar
generator client {
  provider = "prisma-client-js"
  output   = "../../backend/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum EntryStatus {
  NO_CONTACT
  CONTACT
  RESET
}

enum NoticeType {
  INFO
  WARNING
  SUCCESS
  DANGER
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role     @default(USER)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  targets         Target[]
  calendarEntries CalendarEntry[]
  userNotices     UserNotice[]

  @@map("users")
}

model Target {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  displayName String   @map("display_name")
  createdAt   DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries CalendarEntry[]

  @@unique([userId, displayName])
  @@map("targets")
}

model CalendarEntry {
  id           String      @id @default(uuid())
  userId       String      @map("user_id")
  targetId     String      @map("target_id")
  entryDate    DateTime    @db.Date @map("entry_date")
  status       EntryStatus?
  note         String?     @db.Text
  emotionText  String?     @map("emotion_text")
  emotionEmoji String?     @map("emotion_emoji")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  target Target @relation(fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId, entryDate])
  @@map("calendar_entries")
}

model Banner {
  id        String   @id @default(uuid())
  imageUrl  String   @map("image_url")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("banners")
}

model Notice {
  id        String     @id @default(uuid())
  title     String
  message   String     @db.Text
  type      NoticeType @default(INFO)
  linkUrl   String?
  createdAt DateTime   @default(now()) @map("created_at")

  userNotices UserNotice[]

  @@map("notices")
}

model UserNotice {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  noticeId  String   @map("notice_id")
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  @@unique([userId, noticeId])
  @@map("user_notices")
}
